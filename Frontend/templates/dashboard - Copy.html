<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - RowReport</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='Media/logo.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='static/dashboard.css') }}">

</head>

<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="bg-dark text-white d-flex flex-column p-3 vh-100" style="width:250px; position: sticky; top: 0;">
            <div class="text-center sidebar-logo-container">
                <img src="{{ url_for('static', filename='Media/heading_resize.png') }}" alt="Logo" class="img-fluid">
            </div>
            <ul class="nav flex-column mb-auto" style="background-color: #1f1f1f; border-radius: 8px; padding: 10px;">
            <li class="nav-item mb-2">
                <a href="/dashboard" class="nav-link d-flex align-items-center px-3 py-2 rounded text-white
                {% if page == 'dashboard' %}active{% endif %}">
                <i class="fa fa-home me-3 fs-5"></i>
                <span>Athlete Dashboard</span>
                </a>
            </li>
            <li class="nav-item mb-2">
                <a href="/dashboard/sessions" class="nav-link d-flex align-items-center px-3 py-2 rounded text-white
                {% if page == 'sessions' %}active{% endif %}">
                <i class="fa fa-calendar me-3 fs-5"></i>
                <span>Sessions</span>
                </a>
            </li>
            {% if user.is_coach %}
            <li class="nav-item mb-2">
                <a href="/dashboard/upload" class="nav-link d-flex align-items-center px-3 py-2 rounded text-white
                {% if page == 'upload' %}active{% endif %}">
                <i class="fa fa-upload me-3 fs-5"></i>
                <span>Upload Data</span>
                </a>
            </li>
            {% endif %}
            {% if user.is_admin %}
            <li class="nav-item mb-2">
                <a href="/dashboard/admin" class="nav-link d-flex align-items-center px-3 py-2 rounded text-white
                {% if page == 'admin' %}active{% endif %}">
                <i class="fa fa-user-shield me-3 fs-5"></i>
                <span>Admin</span>
                </a>
            </li>
            {% endif %}
            </ul>
            <div class="mt-auto pt-3 border-top">
                <p>Developed by Ben Loggie</p>
                <div class="d-flex align-items-center mb-2">
                    <span>{{ user.email }}</span>
                </div>
                <a href="/account" class="btn btn-outline-light btn-sm w-100 mb-2">Account</a>
                <a href="/logout" class="btn btn-danger btn-sm w-100">Logout</a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-grow-1 p-4">
            {% if page == 'dashboard' %}
                <h2 class="mb-4">Welcome {{ user.last_name }}, {{ user.first_name }}</h2>

                <!-- Top Summary Cards -->
                <div class="row mb-4 g-3">
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm h-100">
                            <div class="card-body">
                                <h6 class="text-muted">Sessions</h6>
                                <h3 class="fw-bold">{{ summary.num_sessions }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm h-100">
                            <div class="card-body">
                                <h6 class="text-muted">Strokes Recorded</h6>
                                <h3 class="fw-bold">{{ summary.total_strokes }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm h-100">
                            <div class="card-body">
                                <h6 class="text-muted">Distance Recorded</h6>
                                <h3 class="fw-bold">{{ summary.total_distance | round(2) }} m</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm h-100">
                            <div class="card-body">
                                <h6 class="text-muted">User Type</h6>
                                <h3 class="fw-bold">{{ summary.user_type }}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Averages (full width under summary cards) -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">User Averages</h5>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Min Angle</th>
                                    <th>Max Angle</th>
                                    <th>Arc Length</th>
                                    <th>Catch Slip</th>
                                    <th>Finish Slip</th>
                                    <th>Swivel Power</th>
                                    <th>Seat Length</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>{{ averages.min_angle }}</td>
                                    <td>{{ averages.max_angle }}</td>
                                    <td>{{ averages.arc_length }}</td>
                                    <td>{{ averages.catch_slip }}</td>
                                    <td>{{ averages.finish_slip }}</td>
                                    <td>{{ averages.swivel_power }}</td>
                                    <td>{{ averages.seat_length }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Two plots side by side -->
                <div class="row g-5 mb-5">
                    <!-- Radar Chart -->
                    <div class="col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">Synchronisation Average</h5>
                            </div>
                            <div class="card-body d-flex justify-content-center align-items-center">
                                <div style="width: 100%; height: 100%">
                                    {{ radar | safe }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- GateForceX Curve -->
                    <div class="col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">GateForceX Curve</h5>
                            </div>
                            <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                                {{ gateforcex | safe }}
                            </div>
                        </div>
                    </div>
                </div>

            {% elif page == 'upload' %}
                <h2>Upload Data</h2>
                <div class="card p-4 shadow-sm mt-3">
                    <form action="/dashboard/upload" method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label">Choose a text file (.txt, .csv)</label>
                            <input class="form-control" type="file" id="file" name="file" accept=".txt,.csv" required>
                        </div>
                        <button type="submit" name="action" class="btn btn-primary" value="upload">Upload</button>
                    </form>
                </div>

                <!-- Upload Session Modal -->
                <div class="modal fade" id="uploadSessionModal" tabindex="-1" aria-labelledby="uploadSessionLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="uploadSessionLabel">Upload Session</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form action="/dashboard/upload" method="POST" enctype="multipart/form-data">
                                <div class="modal-body">
                                    <div class="container-fluid">
                                        {% if rowers %} 
                                            {% for rower in rowers %}
                                                <div class="row align-items-center mb-3">
                                                    <div class="col-md-3"><strong>{{ rower.name }}</strong></div>
                                                    <div class="col-md-2">Seat: {{ rower.seat }}</div>
                                                    <div class="col-md-2">Side: {{ rower.side }}</div>
                                                    <div class="col-md-5">
                                                        <select class="form-control user-dropdown" name="user_search_{{ rower.seat }}" style="width:100%">
                                                            <option value="">Select user...</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <p>No rowers detected for this session.</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="modal-body d-flex flex-column align-items-center">
                                    <!-- Dropdown -->
                                    <div class="mb-3 w-100">
                                        <h5>Select training zone</h5>
                                        <select class="form-select" aria-label="Default select example" name="state_selected">
                                            <option selected>Select an option</option>
                                            <option value="UT1">UT1</option>
                                            <option value="UT2">UT2 (Steady)</option>
                                        </select>
                                    </div>
                                    <!-- Textarea for taller input -->
                                    <div class="w-100">
                                        <h5>Add coach feedback / session description</h5>
                                        <textarea class="form-control" rows="5" placeholder="Description..." name="description_input"></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" name="action" class="btn btn-primary" value="confirm_upload">Upload</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            {% elif page == 'sessions' %}
                <h2>Your sessions</h2>
                <div class="card p-4 shadow-sm mt-3"> 
                    <table class="table table-striped table-bordered shadow-sm mb-4">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>File Name</th>
                                <th>Training Zone</th>
                                <th>Date</th>
                                <th>Number of Rowers</th>
                                <th>Strokes Recorded</th>
                                <th>Total Distance (m)</th>
                                <th>Time Elapsed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in sessions %}
                                <tr>
                                    <td>{{ session.id }}</td>
                                    <td>{{ session.filename }}</td>
                                    <td>{{ session.state }}</td>
                                    <td>{{ session.date }}</td>
                                    <td>{{ session.seats }}</td>
                                    <td>{{ session.tstrokes }}</td>
                                    <td>{{ session.distance | round(2) }} (m)</td>
                                    <td>{{ session.timeelapsed }}</td>
                                    <td><a href="/dashboard/sessions/{{ session.id }}/overview" class="btn btn-sm btn-info">View Session</a></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>  
                </div>

            {% elif page == 'overview' %}
                <h2>Session Details - ID {{ boat_data.id }}</h2>
                <!-- Heading to select page -->
                <div>
                    <a href="/dashboard/sessions/{{ boat_data.id }}/overview" class="btn btn-primary mt-3">Overview</a>
                    <a href="/dashboard/sessions/{{ boat_data.id }}/average" class ="btn btn-secondary mt-3">Average</a>
                    <a href="/dashboard/sessions/{{ boat_data.id }}/samples" class="btn btn-secondary mt-3">Samples</a>
                </div>

                <div class="card p-4 shadow-sm mt-3">
                    <p><strong>File Name:</strong> {{ boat_data.filename }}</p>
                    <p><strong>Date:</strong> {{ boat_data.date }}</p>
                    <p><strong>Training Zone:</strong> {{boat_data.state }}</p>
                    <p><strong>Number of Rowers:</strong> {{ boat_data.seats }}</p>
                    <p><strong>Total Strokes:</strong> {{ boat_data.tstrokes }}</p>
                    <p><strong>Total Distance (m):</strong> {{ boat_data.distance | round(2) }}</p>
                    <p><strong>Time Elapsed (h:m:s):</strong> {{ boat_data.timeelapsed }}</p>
                    
                    <h5>Coach Feedback / Session Description</h5>
                    <p>{{ boat_data.description }}</p>

                    <!-- Crew List -->
                    <h4 class="mt-4">Crew List</h4>
                    <table class="table table-striped table-bordered shadow-sm mb-4">
                        <thead>
                            <tr>
                                <th>Seat</th>
                                <th>Side</th>
                                <th>Name</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rower in rowers %}
                            <tr>
                                <td>{{ rower.telemetry.seat }}</td>
                                <td>{{ rower.telemetry.side }}</td>
                                <td>{{ rower.telemetry.name }}</td>
                                <td>
                                    {% if rower.user.user_id %}
                                        {{ rower.user.first_name }} {{rower.user.last_name }} ({{ rower.user.email }})
                                    {% else %}
                                        Unassigned
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <a href="/dashboard/sessions" class="btn btn-secondary mt-3">Back to Sessions</a>
                    {% if user.is_coach %}
                        <form action="/dashboard/sessions/{{ boat_data.id }}/overview" method="POST" enctype="multipart/form-data">
                            <button type="submit" name='action' value="delete_session" class="btn btn-primary" style="background-color: red; border-color: red;" onclick="return confirm('Are you sure you want to delete this session?');">Delete Session</button>
                        </form>
                    {% endif %}
                </div>

            {% elif page == 'average' %}
                <!-- Heading to select page -->
                <h2>Average Session Statistics</h2>
                <div>
                    <a href="/dashboard/sessions/{{ boat_data.id }}/overview" class="btn btn-secondary mt-3">Overview</a>
                    <a href="/dashboard/sessions/{{ boat_data.id }}/average" class ="btn btn-primary mt-3">Average</a>
                    <a href="/dashboard/sessions/{{ boat_data.id }}/samples" class="btn btn-secondary mt-3">Samples</a>
                </div>
                
                <div class="card p-4 shadow-sm mt-3 table-responsive" >
                        <h5 class="mt-3">Average Data</h5>
                        {% set rating = (boat_data.rating | sum) / (boat_data.rating | length) %}
                        {% set power = (boat_data.averagepower | sum) / (boat_data.averagepower | length) %}
                        {% set dps = (boat_data.distanceperstroke | sum) / (boat_data.distanceperstroke | length) %}
                        {% set mps = (boat_data.meterspersecond | sum) / (boat_data.meterspersecond | length) %}

                        <h6>Rate {{ rating | round(2) }} (s/m) | Avg Power {{ power | round(2) }} (w) | Distance per Stroke {{ dps | round(2) }} (m) | Boat Speed {{ mps | round(2) }} (m/s)</h6>
                        <table class="table table-striped table-hover table-borderless shadow-sm mb-4">
                            <thead class="table-light">
                                <tr>
                                    <th>Seat</th>
                                    <th>Name</th>
                                    <th>Drive Time (s)</th>
                                    <th>Recovery Time (s)</th>
                                    <th>Rhythmn (%)</th>
                                    <th>Min Angle (deg)</th>
                                    <th>Max Angle (deg)</th>
                                    <th>Arc Length (deg)</th>
                                    <th>Catch Slip (deg)</th>
                                    <th>Finish Slip (deg)</th>
                                    <th>Effective Length (deg)</th>
                                    <th>Catch Factor (ms)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rower in rowers %}

                                    {% set data = rower.telemetry %}
                                    {% set drive_time = (data.drive_time | sum) / (data.drive_time | length) %}
                                    {% set recovery_time = (data.recovery_time | sum) / (data.recovery_time | length) %}
                                    {% set min_angle = (data.min_angle | sum) / (data.min_angle | length) %}
                                    {% set max_angle = (data.max_angle | sum) / (data.max_angle | length) %}
                                    {% set arc_length = (data.arc_length | sum) / (data.arc_length | length) %}
                                    {% set catch_slip = (data.catch_slip | sum) / (data.catch_slip | length) %}
                                    {% set finish_slip = (data.finish_slip | sum) / (data.finish_slip | length) %}
                                    {% set catch_factor = (data.catch_factor | sum) / (data.catch_factor | length) %}

                                    <tr>
                                        <td>{{ rower.telemetry.seat }}</td>
                                        <td>{{ rower.user.last_name }}</td>

                                        <td>{{ drive_time | round(2) }}</td>
                                        <td>{{ recovery_time | round(2)}}</td>
                                        <td>{{ ((drive_time / (recovery_time + drive_time)) * 100) | round(2) }}</td>
                                        <td>{{ min_angle | round(2) }}</td>
                                        <td>{{ max_angle | round(2) }}</td>
                                        <td>{{ arc_length | round(2) }}</td>
                                        <td>{{ catch_slip | round(2) }}</td>
                                        <td>{{ finish_slip | round(2) }}</td>
                                        <td>{{ ((arc_length) - (catch_slip + finish_slip)) | round(2) }}</td>
                                        <td>{{ catch_factor | round(2) }}</td>
                                        
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <table class="table table-striped table-hover table-borderless shadow-sm mb-4">
                            <thread>
                                <tr>
                                    <th>Seat</th>

                                    <th>Power (w)</th>
                                    <th>Max Force (kg)</th>
                                    <th>Average Force (kg)</th>
                                    <th>Aver / Max Force (%)</th>
                                    <th>Position of Peak Force (%)</th>
                                    <th>Catch Force Gradient (deg)</th>
                                    <th>Finish Force Gradient (deg)</th>
                                    <th>Legs Drive (cm)</th>
                                    <th>Legs Max Velocity (m/s)</th>
                                </tr>
                            </thread>  
                            <tbody>
                                {% for rower in rowers %}

                                    {% set data = rower.telemetry %}

                                    {% set swivel_power = (data.rower_swivel_power | sum) / (data.rower_swivel_power | length) %}
                                    {% set max_gate_force_x = (data.max_gate_force_x | sum) / (data.max_gate_force_x | length) %}
                                    {% set average_gate_force_x = (data.average_gate_force_x | sum) / (data.average_gate_force_x | length) %}
                                    {% set avermax = ((average_gate_force_x / max_gate_force_x) * 100) | round(2) %}
                                    {% set position_of_maxf = (data.position_of_maxf | sum) / (data.position_of_maxf | length) %}
                                    {% set catch_force_gradient = (data.catch_force_gradient | sum) / (data.catch_force_gradient | length) %}
                                    {% set finish_force_gradient = (data.finish_force_gradient | sum) / (data.finish_force_gradient | length) %}
                                    {% set seat_length = (data.seat_length | sum) / (data.finish_force_gradient | length) %}
                                    {% set legs_max_vel = (data.legs_max_vel | sum) / (data.legs_max_vel | length) %}

                                    <tr>
                                        <td>{{ rower.telemetry.seat }}</td>

                                        <td>{{ swivel_power | round(2) }}</td>
                                        <td>{{ max_gate_force_x | round(2) }}</td>
                                        <td>{{ average_gate_force_x | round(2) }}</td>
                                        <td>{{ avermax | round(2) }}</td>
                                        <td>{{ position_of_maxf | round(2) }}</td>
                                        <td>{{ catch_force_gradient | round(2) }}</td>
                                        <td>{{ finish_force_gradient | round(2) }}</td>
                                        <td>{{ seat_length | round(2) }}</td>
                                        <td>{{ legs_max_vel | round(2) }}</td>
                                    </tr>

                                {% endfor %}
                            </tbody>    
                        </table>
                        <h4>Syncronisation</h4>
                        <table class="table table-striped table-hover table-borderless shadow-sm mb-4">
                            <!-- Syncronisation -->
                            <threat>
                                <tr>
                                    <th>Seat</th>
                                    <th>25% Recovery</th>
                                    <th>50% Recovery</th>
                                    <th>75% Recovery</th>
                                    <th>Hang Start</th>
                                    <th>Min Angle</th>
                                    <th>Hang End</th>
                                    <th>Effect Start</th>
                                    <th>Up-to 70% Peak Force</th>
                                    <th>Peak Force</th>
                                    <th>From 70% Peak Force</th>
                                    <th>Effect End</th>
                                    <th>Pause Start</th>
                                    <th>Max Angle</th>
                                    <th>Release</th>
                                </tr>
                            </threat>
                            <tbody>
                                {% for rower in rowers %}
                                    {% set difference_25 = (rower.telemetry.difference_25 | sum) / (rower.telemetry.difference_25 | length) %}
                                    {% set difference_50 = (rower.telemetry.difference_50 | sum) / (rower.telemetry.difference_50 | length) %}
                                    {% set difference_75 = (rower.telemetry.difference_75 | sum) / (rower.telemetry.difference_75 | length) %}
                                    {% set difference_hang = (rower.telemetry.difference_hang | sum) / (rower.telemetry.difference_hang | length) %}
                                    {% set difference_min = (rower.telemetry.difference_min | sum) / (rower.telemetry.difference_min | length) %}
                                    {% set difference_catch = (rower.telemetry.difference_catch | sum) / (rower.telemetry.difference_catch | length) %}
                                    {% set difference_effective_start = (rower.telemetry.difference_effective_start | sum) / (rower.telemetry.difference_effective_start | length) %}
                                    {% set difference_70max = (rower.telemetry.difference_70max | sum) / (rower.telemetry.difference_70max | length) %}
                                    {% set difference_max = (rower.telemetry.difference_max | sum) / (rower.telemetry.difference_max | length) %}
                                    {% set difference_max70 = (rower.telemetry.difference_max70 | sum) / (rower.telemetry.difference_max70 | length) %}
                                    {% set difference_effective_end = (rower.telemetry.difference_effective_end | sum) / (rower.telemetry.difference_effective_end | length) %}
                                    {% set difference_finish = (rower.telemetry.difference_finish | sum) / (rower.telemetry.difference_finish | length) %}
                                    {% set difference_recovery = (rower.telemetry.difference_recovery | sum) / (rower.telemetry.difference_recovery | length) %}

                                    <tr>
                                        <td>{{ rower.telemetry.seat }}</td>
                                        <td>{{ difference_25 | round(2) }}</td>
                                        <td>{{ difference_50 | round(2) }}</td>
                                        <td>{{ difference_75 | round(2) }}</td>
                                        <td>{{ difference_hang | round(2) }}</td>
                                        <td>{{ difference_min | round(2) }}</td>
                                        <td>{{ difference_catch | round(2) }}</td>
                                        <td>{{ difference_effective_start | round(2) }}</td>
                                        <td>{{ difference_70max | round(2)}}</td>
                                        <td>{{ difference_max | round(2)}}</td>
                                        <td>{{ difference_max70 | round(2)}}</td>
                                        <td>{{ difference_effective_end | round(2)}}</td>
                                        <td>{{ difference_finish | round(2)}}</td>
                                        <td>{{ difference_max | round(2)}}</td>
                                        <td>{{ difference_recovery | round(2)}}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <!-- Graphs Section -->
                        <div class="row g-4 mb-5">
                            <!-- Synchronisation Average -->
                            <div class="col-lg-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div style="width: 100%; height: 100%">
                                            {{ graphs.syncronisation | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Seat Posn / Gate Angle-->
                            <div class="col-lg-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div style="width: 100%; height: 100%">
                                            {{ graphs.seatposition | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- GateForceX Curve -->
                        <div class="card shadow-sm h-100 mb-4"> <!-- Added mb-4 here to create space below -->
                            <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                                <div style="width: 100%; height: 100%">
                                    {{ graphs.gateforcex | safe }}
                                </div>
                            </div>
                        </div>

                        <!-- Ratios Plot -->
                        <div class="card shadow-sm h-100 mb-4"> <!-- Added mb-4 here to create space below -->
                            <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                                <div style="width: 100%; height: 100%">
                                    {{ graphs.ratios | safe }}
                                </div>
                            </div>
                        </div>

                        <div class="row g-4 mb-5">
                            <!-- Gate Angle Velocity -->
                            <div class="col-lg-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                                        <div style="width: 100%; height: 100%">
                                            {{ graphs.gateanglevelocity | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Legs Velocity -->
                            <div class="col-lg-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                                        <div style="width: 100%; height: 100%">
                                            {{ graphs.legsvelocity | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Legs Velocity / Gate Angle -->
                            <div class="col-lg-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                                        <div style="width: 100%; height: 100%">
                                            {{ graphs.legsvelocitygateangle | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Body Trunk Velocity / Gate Angle -->
                            <div class="col-lg-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                                        <div style="width: 100%; height: 100%">
                                            {{ graphs.bodyarmsvelocity | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            {% elif page == 'samples' %}
                <!-- Heading to select page -->
                <h2>Session Sampled Statistics</h2>
                <div>
                    <a href="/dashboard/sessions/{{ boat_data.id }}/overview" class="btn btn-secondary mt-3">Overview</a>
                    <a href="/dashboard/sessions/{{ boat_data.id }}/average" class ="btn btn-secondary mt-3">Average</a>
                    <a href="/dashboard/sessions/{{ boat_data.id }}/samples" class="btn btn-primary mt-3">Samples</a>
                </div>
                <!-- Sampled Data -->   
                {% for sample in range(0, 8) %} 
                    <div class="card p-4 shadow-sm mt-3 table-responsive" >
                        <h5 class="mt-3">Sample {{ sample + 1 }}/8</h5>
                        <h6>Rate {{ boat_data.rating[sample] }} (s/m) | Avg Power {{ boat_data.averagepower[sample] }} (w) | Distance per Stroke {{ boat_data.distanceperstroke[sample] }} (m) | Boat Speed {{ boat_data.meterspersecond[sample] }} (m/s)</h6>
                        <table class="table table-striped table-hover table-borderless shadow-sm mb-4">
                            <thead class="table-light">
                                <tr>
                                    <th>Seat</th>
                                    <th>Name</th>
                                    <th>Drive Time (s)</th>
                                    <th>Recovery Time (s)</th>
                                    <th>Rhythmn (%)</th>
                                    <th>Min Angle (deg)</th>
                                    <th>Max Angle (deg)</th>
                                    <th>Arc Length (deg)</th>
                                    <th>Catch Slip (deg)</th>
                                    <th>Finish Slip (deg)</th>
                                    <th>Effective Length (deg)</th>
                                    <th>Catch Factor (ms)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rower in rowers %}

                                    {% set drive_time = rower.telemetry.drive_time[sample] %}
                                    {% set recovery_time = rower.telemetry.recovery_time[sample] %}
                                    {% set min_angle = rower.telemetry.min_angle[sample] %}
                                    {% set max_angle = rower.telemetry.max_angle[sample] %}
                                    {% set arc_length = rower.telemetry.arc_length[sample] %}
                                    {% set catch_slip = rower.telemetry.catch_slip[sample] %}
                                    {% set finish_slip = rower.telemetry.finish_slip[sample] %}
                                    {% set catch_factor = rower.telemetry.catch_factor[sample] %}

                                    <tr>
                                        <td>{{ rower.telemetry.seat }}</td>
                                        <td>{{ rower.user.last_name }}</td>

                                        <td>{{ drive_time }}</td>
                                        <td>{{ recovery_time }}</td>
                                        <td>{{ ((drive_time / (recovery_time + drive_time)) * 100) | round(2) }}</td>
                                        <td>{{ min_angle }}</td>
                                        <td>{{ max_angle }}</td>
                                        <td>{{ arc_length }}</td>
                                        <td>{{ catch_slip }}</td>
                                        <td>{{ finish_slip }}</td>
                                        <td>{{ ((arc_length) - (catch_slip + finish_slip)) | round(2)}}</td>
                                        <td>{{ catch_factor }}</td>
                                        
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <table class="table table-striped table-hover table-borderless shadow-sm mb-4">
                            <thread>
                                <tr>
                                    <th>Seat</th>

                                    <th>Power (w)</th>
                                    <th>Max Force (kg)</th>
                                    <th>Average Force (kg)</th>
                                    <th>Aver / Max Force (%)</th>
                                    <th>Position of Peak Force (%)</th>
                                    <th>Catch Force Gradient (deg)</th>
                                    <th>Finish Force Gradient (deg)</th>
                                    <th>Legs Drive (cm)</th>
                                    <th>Legs Max Velocity (m/s)</th>
                                </tr>
                            </thread>  
                            <tbody>
                                {% for rower in rowers %}

                                    {% set swivel_power = rower.telemetry.rower_swivel_power[sample] %}
                                    <tr>
                                        <td>{{ rower.telemetry.seat }}</td>

                                        <td>{{ rower.telemetry.rower_swivel_power[sample] }}</td>
                                        <td>{{ rower.telemetry.max_gate_force_x[sample] }}</td>
                                        <td>{{ rower.telemetry.average_gate_force_x[sample] }}</td>
                                        <td>{{ ((rower.telemetry.average_gate_force_x[sample] / rower.telemetry.max_gate_force_x[sample]) * 100) | round(2) }}</td>
                                        <td>{{ rower.telemetry.position_of_maxf[sample] }}</td>
                                        <td>{{ rower.telemetry.catch_force_gradient[sample] }}</td>
                                        <td>{{ rower.telemetry.finish_force_gradient[sample] }}</td>
                                        <td>{{ rower.telemetry.seat_length[sample] }}</td>
                                        <td>{{ rower.telemetry.legs_max_vel[sample] }}</td>
                                    </tr>

                                {% endfor %}
                            </tbody>    
                        </table>
                        <h4>Syncronisation</h4>
                        <table class="table table-striped table-hover table-borderless shadow-sm mb-4">
                            <!-- Syncronisation -->
                            <threat>
                                <tr>
                                    <th>Seat</th>
                                    <th>25% Recovery</th>
                                    <th>50% Recovery</th>
                                    <th>75% Recovery</th>
                                    <th>Hang Start</th>
                                    <th>Min Angle</th>
                                    <th>Hang End</th>
                                    <th>Effect Start</th>
                                    <th>Up-to 70% Peak Force</th>
                                    <th>Peak Force</th>
                                    <th>From 70% Peak Force</th>
                                    <th>Effect End</th>
                                    <th>Pause Start</th>
                                    <th>Max Angle</th>
                                    <th>Release</th>
                                </tr>
                            </threat>
                            <tbody>
                                {% for rower in rowers %}

                                    <tr>
                                        <td>{{ rower.telemetry.seat }}</td>

                                        <td>{{ rower.telemetry.difference_25[sample] }}</td>
                                        <td>{{ rower.telemetry.difference_50[sample] }}</td>
                                        <td>{{ rower.telemetry.difference_75[sample] }}</td>
                                        <td>{{ rower.telemetry.difference_hang[sample] }}</td>
                                        <td>{{ rower.telemetry.difference_min[sample] }}</td>
                                        <td>{{ rower.telemetry.difference_catch[sample] }}</td>
                                        <td>{{ rower.telemetry.difference_effective_start[sample] }}</td>  
                                        <td>{{ rower.telemetry.difference_70max[sample] }}</td>
                                        <td>{{ rower.telemetry.difference_max[sample] }}</td>
                                        <td>{{ rower.telemetry.difference_max70[sample] }}</td>
                                        <td>{{ rower.telemetry.difference_effective_end[sample] }}</td>
                                        <td>{{ rower.telemetry.difference_finish[sample] }}</td>
                                        <td>{{ rower.telemetry.difference_max[sample] }}</td>
                                        <td>{{ rower.telemetry.difference_recovery[sample] }}</td>
                                    </tr>

                                {% endfor %}
                            </tbody>
                        </table>
                        <!-- Graphs Section -->
                        <div class="row g-4 mb-5">
                            <!-- Synchronisation Average -->
                            <div class="col-lg-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div style="width: 100%; height: 100%">
                                            {{ graphs.syncronisation[sample] | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Seat Posn / Gate Angle-->
                            <div class="col-lg-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div style="width: 100%; height: 100%">
                                            {{ graphs.seatposition[sample] | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- GateForceX Curve -->
                        <div class="card shadow-sm h-100 mb-4"> <!-- Added mb-4 here to create space below -->
                            <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                                <div style="width: 100%; height: 100%">
                                    {{ graphs.gateforcex[sample] | safe }}
                                </div>
                            </div>
                        </div>

                        <!-- Ratios Plot -->
                        <div class="card shadow-sm h-100 mb-4"> <!-- Added mb-4 here to create space below -->
                            <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                                <div style="width: 100%; height: 100%">
                                    {{ graphs.ratios[sample] | safe }}
                                </div>
                            </div>
                        </div>

                        <div class="row g-4 mb-5">
                            <!-- Gate Angle Velocity -->
                            <div class="col-lg-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                                        <div style="width: 100%; height: 100%">
                                            {{ graphs.gateanglevelocity[sample] | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Legs Velocity -->
                            <div class="col-lg-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                                        <div style="width: 100%; height: 100%">
                                            {{ graphs.legsvelocity[sample] | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Legs Velocity / Gate Angle -->
                            <div class="col-lg-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                                        <div style="width: 100%; height: 100%">
                                            {{ graphs.legsvelocitygateangle[sample] | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Body Trunk Velocity / Gate Angle -->
                            <div class="col-lg-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                                        <div style="width: 100%; height: 100%">
                                            {{ graphs.bodyarmsvelocity[sample] | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}

            {% elif page == 'admin' %}
                <h2>Admin Panel</h2>
                <div class="card p-4 shadow-sm mt-3">
                    <h5>User Management</h5>
                    <table class="table table-striped table-bordered shadow-sm mb-4">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>User Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in all_users %}
                            <tr>
                                <td>{{ u.id }}</td>
                                <td>{{ u.first_name }} {{ u.last_name }}</td>
                                <td>{{ u.email }}</td>
                                <td>
                                    {% if u.is_admin %} Admin {% elif u.is_coach %} Coach {% elif u.is_athlete %} Athlete {% else %} N/A {% endif %}
                                </td>
                                <td>
                                    <!-- Actions like Edit, Delete can be added here -->
                                    <button class="btn btn-sm btn-warning">Edit</button>
                                    <form action="/dashboard/admin/delete_user/{{ u.id }}" method="POST">
                                        <button class="btn btn-sm btn-danger" type="submit" onclick="return confirm('Are you sure you want to delete this user?')" class="btn btn-danger">Delete User</button>
                                    </form>                                
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>  
                </div>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Select2 Initialization
        var modalEl = document.getElementById('uploadSessionModal');
        if (modalEl) {
            modalEl.addEventListener('shown.bs.modal', function() {
                $('.user-dropdown').select2({
                    placeholder: "Search for a user",
                    ajax: {
                        url: 'http://localhost:8000/get_all_users',
                        dataType: 'json',
                        delay: 250,
                        processResults: function(data) {
                            return {
                                results: data.map(user => ({
                                    id: user.id,
                                    text: user.first_name + " " + user.last_name + " (" + user.email + ")"
                                }))
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 0,
                    dropdownParent: $('#uploadSessionModal')
                });
            });
        }

        // Show modal if needed
        document.addEventListener("DOMContentLoaded", function() {
            {% if show_upload_modal %}
            if (modalEl) {
                var myModal = new bootstrap.Modal(modalEl);
                myModal.show();
            }
            {% endif %}
        });
    </script>
</body>

</html>